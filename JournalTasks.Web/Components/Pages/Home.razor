@page "/"
@using System.Linq

@rendermode InteractiveServer
 

<h3>Планировщик с управлением задачами (CRUD)</h3>

@if (isEditing && currentTask != null)
{
    <div class="edit-form-overlay">
        <div class="edit-form">
            <h4>@(currentTask.Id == 0 ? "Создать" : "Редактировать") задачу</h4>
            <RadzenTemplateForm TItem="TaskModel" Data="@currentTask" Submit="@SaveTask">
                <RadzenFieldset Text="Детали задачи">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <RadzenLabel Text="Заголовок" />
                            <RadzenTextBox @bind-Value="@currentTask.Title" Class="w-100" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <RadzenLabel Text="Начало" />
                            <RadzenDatePicker @bind-Value="@currentTask.Start" ShowTime="true" DateFormat="dd.MM.yyyy HH:mm" Class="w-100" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <RadzenLabel Text="Конец" />
                            <RadzenDatePicker @bind-Value="@currentTask.End" ShowTime="true" DateFormat="dd.MM.yyyy HH:mm" Class="w-100" />
                        </div>
                    </div>
                </RadzenFieldset>
                <div class="mt-3">
                    <RadzenButton ButtonType="ButtonType.Submit" Text="Сохранить" ButtonStyle="ButtonStyle.Success" />
                    <RadzenButton Click="@(() => isEditing = false)" Text="Отмена" ButtonStyle="ButtonStyle.Light" Class="ms-2" />
                </div>
            </RadzenTemplateForm>
        </div>
    </div>
}

<RadzenScheduler @bind-Date="@date" 
                 Data="@DailyTasks"
                 StartProperty="Start"
                 EndProperty="End"
                 TextProperty="Title" 
                 TItem="TaskModel"
                 AppointmentRender=@OnAppointmentRender
                 Style="height: 500px; margin-top: 20px;">
    
    <RadzenDayView />
    <RadzenWeekView />
    <RadzenMonthView />
    
</RadzenScheduler>

<hr />

<RadzenButton Icon="add_circle_outline" Text="Добавить новую задачу" Click="@AddNewTask" ButtonStyle="ButtonStyle.Primary" Class="mb-3" />

@code {
   
      
    public class TaskModel
    {
        public int Id { get; set; }
        public string Title { get; set; }
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public string Color { get; set; } = "blue-task";
    }
  
    DateTime date = DateTime.Today; 
    
    IList<TaskModel> DailyTasks = new List<TaskModel>();
    
     TaskModel currentTask;
    
    bool isEditing = false;
    
     int nextId = 5;

     protected override void OnInitialized()
    {
        DailyTasks = new List<TaskModel>
        {
            new TaskModel 
            { 
                Id = 1, 
                Title = "Проверка почты", 
                Start = date.AddHours(9).AddMinutes(0), 
                End = date.AddHours(10).AddMinutes(0),
            },
            new TaskModel 
            { 
                Id = 2, 
                Title = "Встреча с командой", 
                Start = date.AddHours(11).AddMinutes(0), 
                End = date.AddHours(12).AddMinutes(30),
            },
            new TaskModel 
            { 
                Id = 3, 
                Title = "Обед", 
                Start = date.AddHours(13).AddMinutes(0), 
                End = date.AddHours(14).AddMinutes(0),
            },
            new TaskModel 
            { 
                Id = 4, 
                Title = "Работа над документацией", 
                Start = date.AddHours(15).AddMinutes(0), 
                End = date.AddHours(17).AddMinutes(0),
            }
        };
    }
     

     void AddNewTask()
    {
         currentTask = new TaskModel 
        { 
            Id = 0, 
            Title = "Новая задача", 
            Start = DateTime.Now.AddHours(1).Date.AddHours(10), // Предполагаемое время
            End = DateTime.Now.AddHours(1).Date.AddHours(11)
        };
        isEditing = true;
    }

    void Edit(TaskModel task)
    {
         currentTask = new TaskModel 
        { 
            Id = task.Id, 
            Title = task.Title, 
            Start = task.Start, 
            End = task.End,
            Color = task.Color
        };
        isEditing = true;
    }

     void SaveTask()
    {
        if (currentTask == null) return;
        
         if (currentTask.Id > 0)
        {
            var existingTask = DailyTasks.FirstOrDefault(t => t.Id == currentTask.Id);
            if (existingTask != null)
            {
                existingTask.Title = currentTask.Title;
                existingTask.Start = currentTask.Start;
                existingTask.End = currentTask.End;
            }
        }
        else
        {
            currentTask.Id = nextId++;
            DailyTasks.Add(currentTask);
        }

        isEditing = false;
        currentTask = null;
        
        StateHasChanged(); 
    }

    void Delete(TaskModel task)
    {
        DailyTasks.Remove(task);
        
        // Убеждаемся, что форма редактирования скрыта, если удалена текущая редактируемая задача
        if (currentTask != null && currentTask.Id == task.Id)
        {
            isEditing = false;
            currentTask = null;
        }
        
        StateHasChanged();
    }

    private void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<TaskModel> obj) {
         
        obj.Attributes["style"] = "background: red";
         
    }

} 